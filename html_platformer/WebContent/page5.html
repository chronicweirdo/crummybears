<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Bouncy physics</title>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="jquery.hotkeys-0.7.9.min.js"></script>
<script>
	// constants
	var MOVE_STEP = 1;
	var PARTICLE_RADIUS = 5;
	var PARTICLES_NR = 1;
	
	
	// class definitions
	function Particle(p, v) {
		this.p = p;
		this.v = v;
		this.c = "#000000";
		
		this.move = function() {
			this.p.x += this.v.x;
			this.p.y += this.v.y;
			/* if ((this.p.x < 0 && this.v.x < 0) || (this.p.x > canvasWidth() && this.v.x > 0)) {
				this.v.x = - this.v.x;
			}
			if ((this.p.y < 0 && this.v.y < 0) || (this.p.y > canvasHeight() && this.v.y > 0)) {
				this.v.y = - this.v.y;
			} */
		}
		
		this.draw = function() {
			canvas().fillStyle = this.c;
			canvas().beginPath();
			canvas().arc(this.p.x, this.p.y, PARTICLE_RADIUS, 0, 2 * Math.PI, false);
			canvas().fill();
		}
	}

	// objects definition
	var gameHandle;
	var particles = new Array();
	var planeDistances = [400];
	var planes = [ 
	               /*{a: 1,  b: 0, c: 1}*/
	               /*{a: 0, b: -1, c: 1},*/
	               /* {a: -1, b: 0, c: 1} */
	               {a: 0,  b: 1, c: 1}
	              ]; // actually normals to the planes
	
	$(function() {
		// objects creation
		for (i=0; i<PARTICLES_NR; i++) {
			particles[i] = new Particle({x: random(canvasWidth()), y: random(canvasHeight())}, {x: /* random(5) */1, y: 3/* random(5) */});
		}
		// start game
		startAnimation();
	});
	function random(max) {
		return Math.floor(Math.random()*max);
	}
	function update() {
		for (i=0; i<particles.length; i++) {
			particles[i].move();
		}
	}
	function draw() {
		for (i=0; i<particles.length; i++) {
			particles[i].draw();
		}		
	}
	function startAnimation() {
		var FPS = 30;
		gameHandle = setInterval(function() {
			game();
		}, 1000/FPS);
	}
	function clear() {
		canvas().clearRect(0, 0, canvasWidth(), canvasHeight());
	}
	function canvas() {
		return $('#myCanvas').get(0).getContext('2d');
	}
	function canvasWidth() {
		return $('#myCanvas').first().width();
	}
	function canvasHeight() {
		return $('#myCanvas').first().height();
	}
	function game() {
		update();
		checkCollisions();
		clear();
		draw();
	}
	
	function checkCollisions() {
		log("-----");
		for (i = 0; i < particles.length; i++) {
			for (j = 0; j < planes.length; j++) {
				log("v=(" + particles[i].v.x + "," + particles[i].v.y + ")");
				var distance = particles[i].p.x * planes[j].a + particles[i].p.y * planes[j].b + planes[j].c;
				var normalVelocity = particles[i].v.x * planes[j].a + particles[i].v.y * planes[j].b;
				log(distance + ' ' + normalVelocity);
				if (distance < planeDistances[j] && normalVelocity < 0) {
					
					// collision response: R = V - 2*N*(V.N)
					var reflectionVector = new Object();
					reflectionVector.x = particles[i].v.x - 2 * normalVelocity * planes[j].a;
					reflectionVector.y = particles[i].v.y - 2 * normalVelocity * planes[j].b;
					particles[i].v.x = reflectionVector.x;
					particles[i].v.y = reflectionVector.y;
				}
			}
		}
	}
	
	function collide(object1, object2) {
		var r1 = object1.rect();
		var r2 = object2.rect();
		var dx = Math.abs(r1.cx - r2.cx) - (r1.hw + r2.hw);
		var dy = Math.abs(r1.cy - r2.cy) - (r1.hh + r2.hh);
		return (dx < 0) && (dy < 0);
	}
	
	function log(text) {
		$('#console').prepend(text + '<br />');
	}
	
	function clearLog() {
		$('#console').empty();
	}
	
	function stopGame() {
		clearInterval(gameHandle);
	}

</script>
</head>
<body>
	<canvas id="myCanvas" width="1000" height="400" style="border:1px solid #000000;"></canvas>
	<div id="console" style="height: 200px; overflow: scroll;"></div>
	<a onclick="javascript:clearLog()">clear</a>
	<a onclick="javascript:stopGame()">stop</a>
</body>
</html>